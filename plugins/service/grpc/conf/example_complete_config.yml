# Complete gRPC Plugin Configuration Example
# This file demonstrates the configuration structure for both gRPC service and client plugins

lynx:
  grpc:
    # gRPC Service Configuration (Server-side)
    service:
      # Network type: tcp or unix
      network: "tcp"
      
      # Server address and port
      addr: ":9090"
      
      # Enable/disable TLS
      tls_enable: false
      
      # TLS client authentication type:
      # 0: No client authentication
      # 1: Request client certificate, but not mandatory
      # 2: Require client certificate
      # 3: Verify client certificate
      # 4: Verify client certificate if provided
      tls_auth_type: 0
      
      # Request timeout duration (in seconds)
      timeout: 10
      
      # Maximum number of concurrent streams per HTTP/2 connection
      # This is an important parameter for controlling server resource usage
      # Default: 1000 (safe default, adjust based on capacity)
      # Recommended: Set based on your server capacity (typical range: 100-10000)
      # Example values:
      #   - Small service: 100-500
      #   - Medium service: 500-2000
      #   - Large service: 2000-10000
      max_concurrent_streams: 1000

      # Maximum inbound/outbound message sizes (bytes)
      # Default 0 uses gRPC server defaults (~4MB)
      max_recv_msg_size: 10485760   # 10MB
      max_send_msg_size: 10485760   # 10MB

    # gRPC Client Configuration (Client-side)
    client:
      # Default timeout for gRPC client requests
      default_timeout: "10s"
      
      # Default keep-alive interval for gRPC connections
      default_keep_alive: "30s"
      
      # Maximum number of retries for failed requests
      max_retries: 3
      
      # Backoff duration between retries
      retry_backoff: "1s"
      
      # Maximum number of connections per service
      max_connections: 10
      
      # Enable TLS for gRPC client connections
      tls_enable: false
      
      # TLS authentication type (0-4)
      tls_auth_type: 0
      
      # Enable connection pooling
      connection_pooling: true
      
      # Connection pool size
      pool_size: 5
      
      # Service subscription configurations (recommended)
      # Use this for services discovered via service registry (like Polaris)
      subscribe_services:
        - name: "user-service"
          # endpoint is optional when using service discovery
          # endpoint: "localhost:9091"  # Only use if service discovery is unavailable
          timeout: "5s"
          tls_enable: true
          tls_auth_type: 2
          required: true  # Check availability at startup
          load_balancer: "round_robin"
          circuit_breaker_enabled: true
          circuit_breaker_threshold: 5
          metadata:
            version: "v1.0"
            region: "us-west"
          
        - name: "order-service"
          timeout: "15s"
          tls_enable: false
          max_retries: 5
          required: false
          load_balancer: "random"
          
        - name: "payment-service"
          # This service has fallback endpoint when service discovery fails
          endpoint: "payment.internal:9093"
          timeout: "8s"
          required: true
          
      # Legacy static service configurations (deprecated)
      # Only use this if you cannot use service discovery
      services:
        - name: "legacy-service"
          endpoint: "legacy.internal:9094"
          timeout: "10s"
          tls_enable: false

# Example with TLS enabled for both service and client
# lynx:
#   grpc:
#     service:
#       network: "tcp"
#       addr: ":9090"
#       tls_enable: true
#       tls_auth_type: 4  # Mutual TLS authentication
#       timeout: 30
#     
#     client:
#       default_timeout: "15s"
#       default_keep_alive: "60s"
#       max_retries: 5
#       retry_backoff: "2s"
#       max_connections: 20
#       tls_enable: true
#       tls_auth_type: 4  # Mutual TLS authentication
#       connection_pooling: true
#       pool_size: 10


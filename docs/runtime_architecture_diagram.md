# Lynx Runtime 架构图

## 整体架构视图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              Lynx Application                                  │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │   LynxApp   │  │    Boot     │  │   Control   │  │   Config    │        │
│  │             │  │             │  │   Plane     │  │             │        │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           Plugin Management Layer                              │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │   Plugin    │  │   Typed     │  │   Plugin    │  │   Plugin    │        │
│  │  Manager    │  │  Plugin     │  │   Factory   │  │   Registry  │        │
│  │             │  │  Manager    │  │             │  │             │        │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              Runtime Layer                                     │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │   Runtime   │  │   Typed     │  │   Simple    │  │   Plugin    │        │
│  │  Interface  │  │  Runtime    │  │   Runtime   │  │  Context    │        │
│  │             │  │   Impl      │  │             │  │             │        │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         Resource Management Layer                              │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │   Private   │  │   Shared    │  │  Resource   │  │  Resource   │        │
│  │  Resources  │  │  Resources  │  │    Info     │  │   Stats     │        │
│  │             │  │             │  │             │  │             │        │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            Event System Layer                                 │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │   Event     │  │   Event     │  │   Event     │  │   Plugin    │        │
│  │  Emitter    │  │  Listener   │  │  History    │  │   Events    │        │
│  │             │  │             │  │             │  │             │        │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## Runtime 核心组件详细视图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              Runtime Interface                                 │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                │
│  │ TypedResource   │  │   Config        │  │   Log           │                │
│  │   Manager       │  │   Provider      │  │   Provider      │                │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘                │
│           │                     │                     │                        │
│           └─────────────────────┼─────────────────────┘                        │
│                                 │                                            │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                │
│  │   Event         │  │   Resource      │  │   Plugin        │                │
│  │   Emitter       │  │   Management    │  │   Context       │                │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘                │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            Runtime Implementation                              │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                        TypedRuntimeImpl                                   │ │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐          │ │
│  │  │   Runtime       │  │   Config        │  │   Log           │          │ │
│  │  │   Wrapper       │  │   Wrapper       │  │   Wrapper       │          │ │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘          │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
│                                        │                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                        simpleRuntime                                      │ │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐          │ │
│  │  │ Private         │  │ Shared          │  │ Resource        │          │ │
│  │  │ Resources       │  │ Resources       │  │ Info            │          │ │
│  │  │ (map[string]    │  │ (map[string]    │  │ (map[string]    │          │ │
│  │  │  map[string]any)│  │  any)           │  │  *ResourceInfo) │          │ │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘          │ │
│  │                                                                           │ │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐          │ │
│  │  │ Event           │  │ Event           │  │ Plugin          │          │ │
│  │  │ Listeners       │  │ History         │  │ Context         │          │ │
│  │  │ (map[string]    │  │ ([]PluginEvent) │  │ (string)        │          │ │
│  │  │  []EventListener)│  │                 │  │                 │          │ │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘          │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 资源管理详细视图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            Resource Management                                 │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                        Private Resources                                  │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │ │
│  │  │ Plugin1     │  │ Plugin2     │  │ Plugin3     │  │ PluginN     │    │ │
│  │  │ Resources   │  │ Resources   │  │ Resources   │  │ Resources   │    │ │
│  │  │             │  │             │  │             │  │             │    │ │
│  │  │ - config    │  │ - config    │  │ - config    │  │ - config    │    │ │
│  │  │ - cache     │  │ - cache     │  │ - cache     │  │ - cache     │    │ │
│  │  │ - state     │  │ - state     │  │ - state     │  │ - state     │    │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘    │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                        Shared Resources                                   │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │ │
│  │  │ Database    │  │ Cache       │  │ Logger      │  │ Config      │    │ │
│  │  │ Connection  │  │ Pool        │  │ Instance    │  │ Manager     │    │ │
│  │  │             │  │             │  │             │  │             │    │ │
│  │  │ - MySQL     │  │ - Redis     │  │ - Zap       │  │ - Viper     │    │ │
│  │  │ - PostgreSQL│  │ - Memcached │  │ - Logrus    │  │ - Etcd      │    │ │
│  │  │ - MongoDB   │  │ - Local     │  │ - Std       │  │ - Consul    │    │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘    │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                        Resource Info                                      │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │ │
│  │  │ Name        │  │ Type        │  │ PluginID    │  │ IsPrivate   │    │ │
│  │  │ CreatedAt   │  │ LastUsedAt  │  │ AccessCount │  │ Size        │    │ │
│  │  │ Metadata    │  │             │  │             │  │             │    │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘    │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 事件系统详细视图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              Event System                                      │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                        Event Listeners                                    │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │ │
│  │  │ Global      │  │ Plugin1     │  │ Plugin2     │  │ PluginN     │    │ │
│  │  │ Listeners   │  │ Listeners   │  │ Listeners   │  │ Listeners   │    │ │
│  │  │             │  │             │  │             │  │             │    │ │
│  │  │ - All       │  │ - Lifecycle │  │ - Lifecycle │  │ - Lifecycle │    │ │
│  │  │   Events    │  │ - Resource  │  │ - Resource  │  │ - Resource  │    │ │
│  │  │ - System    │  │ - Health    │  │ - Health    │  │ - Health    │    │ │
│  │  │   Events    │  │ - Custom    │  │ - Custom    │  │ - Custom    │    │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘    │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                        Event History                                      │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │ │
│  │  │ Event1      │  │ Event2      │  │ Event3      │  │ EventN      │    │ │
│  │  │             │  │             │  │             │  │             │    │ │
│  │  │ - Type      │  │ - Type      │  │ - Type      │  │ - Type      │    │ │
│  │  │ - PluginID  │  │ - PluginID  │  │ - PluginID  │  │ - PluginID  │    │ │
│  │  │ - Timestamp │  │ - Timestamp │  │ - Timestamp │  │ - Timestamp │    │ │
│  │  │ - Metadata  │  │ - Metadata  │  │ - Metadata  │  │ - Metadata  │    │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘    │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                        Event Filters                                      │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │ │
│  │  │ Type        │  │ PluginID    │  │ Time        │  │ Priority    │    │ │
│  │  │ Filter      │  │ Filter      │  │ Filter      │  │ Filter      │    │ │
│  │  │             │  │             │  │             │  │             │    │ │
│  │  │ - Lifecycle │  │ - Specific  │  │ - FromTime  │  │ - High      │    │ │
│  │  │ - Resource  │  │   Plugin    │  │ - ToTime    │  │ - Normal    │    │ │
│  │  │ - Health    │  │ - All       │  │ - Recent    │  │ - Low       │    │ │
│  │  │ - Custom    │  │   Plugins   │  │ - Range     │  │ - Critical  │    │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘    │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 插件上下文详细视图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            Plugin Context                                      │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                        Context Management                                 │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │ │
│  │  │ Plugin1     │  │ Plugin2     │  │ Plugin3     │  │ PluginN     │    │ │
│  │  │ Context     │  │ Context     │  │ Context     │  │ Context     │    │ │
│  │  │             │  │             │  │             │  │             │    │ │
│  │  │ - ID        │  │ - ID        │  │ - ID        │  │ - ID        │    │ │
│  │  │ - Name      │  │ - Name      │  │ - Name      │  │ - Name      │    │ │
│  │  │ - Resources │  │ - Resources │  │ - Resources │  │ - Resources │    │ │
│  │  │ - Events    │  │ - Events    │  │ - Events    │  │ - Events    │    │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘    │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                        Context Operations                                 │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │ │
│  │  │ WithPlugin  │  │ GetCurrent  │  │ SetContext  │  │ Clear       │    │ │
│  │  │ Context     │  │ Context     │  │             │  │ Context     │    │ │
│  │  │             │  │             │  │             │  │             │    │ │
│  │  │ - Create    │  │ - Get       │  │ - Set       │  │ - Remove    │    │ │
│  │  │   Context   │  │   Current   │  │   Context   │  │   Context   │    │ │
│  │  │ - Isolate   │  │   Context   │  │ - Update    │  │ - Cleanup   │    │ │
│  │  │   Resources │  │ - Validate  │  │   Context   │  │   Resources │    │ │
│  │  │ - Events    │  │   Context   │  │ - Events    │  │ - Events    │    │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘    │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 数据流图

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   Plugin    │───▶│   Runtime   │───▶│  Resource   │───▶│   Event     │
│  Manager    │    │  Interface  │    │  Manager    │    │   System    │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
       │                   │                   │                   │
       ▼                   ▼                   ▼                   ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   Plugin    │    │  Typed      │    │  Private    │    │  Event      │
│  Context    │    │  Runtime    │    │  Resources  │    │  Listeners  │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
       │                   │                   │                   │
       ▼                   ▼                   ▼                   ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   Plugin    │    │   Simple    │    │  Shared     │    │  Event      │
│  Lifecycle  │    │   Runtime   │    │  Resources  │    │  History    │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
       │                   │                   │                   │
       ▼                   ▼                   ▼                   ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   Resource  │    │   Config    │    │  Resource   │    │  Event      │
│  Cleanup    │    │  Provider   │    │   Info      │    │  Filters    │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
```

## 总结

这个分层 Runtime 设计提供了：

1. **清晰的层次结构**：从应用层到资源层的明确分层
2. **类型安全**：通过泛型提供类型安全的资源访问
3. **资源隔离**：私有资源和共享资源的逻辑分离
4. **事件驱动**：完善的事件系统支持插件间通信
5. **上下文管理**：插件上下文支持资源隔离和热更新
6. **生命周期管理**：完整的资源跟踪和清理机制

这个架构为 Lynx 框架提供了强大、灵活且可扩展的插件系统基础。
